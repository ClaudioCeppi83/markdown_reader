<!DOCTYPE html>
<html lang="en"> <!-- No default theme class -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Reader</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #18181b;
            --text-color: #d1d5db;
            --header-bg-color: #27272a;
            --border-color: #374151;
            --editor-bg-color: #1d1d20;
            --preview-bg-color: #1d1d20;
            --button-bg-color: #374151;
            --button-hover-bg-color: #4b5563;
            --dropdown-bg-color: #374151;
        }

        html.light {
            --bg-color: #F3F4F6;
            --text-color: #111827;
            --header-bg-color: #FDFDFD;
            --border-color: #e5e7eb;
            --editor-bg-color: #FDFDFD;
            --preview-bg-color: #FDFDFD;
            --button-bg-color: #e5e7eb;
            --button-hover-bg-color: #d1d5db;
            --dropdown-bg-color: #f3f4f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        header {
            background-color: var(--header-bg-color);
            border-bottom: 1px solid var(--border-color);
        }

        #editor, #preview {
            background-color: var(--editor-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .prose {
            color: var(--text-color);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--button-bg-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover-bg-color);
        }

        #editor {
            font-family: 'Fira Code', monospace;
        }
        
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6, .prose strong, .prose code {
            color: var(--text-color);
        }

        /* Custom Dropdown */
        .theme-dropdown {
            position: relative;
            display: inline-block;
        }

        .theme-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--dropdown-bg-color);
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 0.375rem; /* rounded-md */
        }

        .theme-menu button {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .theme-menu button:hover {
            background-color: var(--button-hover-bg-color);
        }

        .bullet {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-color);
            visibility: hidden;
        }

        .theme-menu button.selected .bullet {
            visibility: visible;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="px-4 py-2 flex items-center justify-between w-full">
        <h1 class="text-lg font-bold">Markdown Reader</h1>
        <div class="flex items-center gap-x-4">
            <button id="new-file-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded cursor-pointer">New File</button>
            <button id="save-file-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Save File</button>
            <input type="file" id="file-input" class="hidden" accept=".md,.markdown,.txt">
            <label id="open-file-label" for="file-input" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Open File</label>
            <div class="theme-dropdown">
                <button id="theme-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded cursor-pointer">Theme</button>
                <div id="theme-menu" class="theme-menu">
                    <button data-theme="system"><span class="bullet"></span>System</button>
                    <button data-theme="light"><span class="bullet"></span>Light</button>
                    <button data-theme="dark"><span class="bullet"></span>Dark</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-grow grid grid-cols-2 gap-4 p-4">
        <!-- Editor Panel -->
        <div class="flex flex-col h-full">
            <h2 class="text-md font-semibold mb-2 text-gray-400">Editor</h2>
            <textarea id="editor" class="flex-grow rounded-md p-4 w-full h-full resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <!-- Preview Panel -->
        <div class="flex flex-col h-full">
            <h2 class="text-md font-semibold mb-2 text-gray-400">Preview</h2>
            <div id="preview" class="prose max-w-none h-full overflow-y-auto rounded-md p-4"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview');
            const fileInput = document.getElementById('file-input');
            const newFileBtn = document.getElementById('new-file-btn');
            const saveFileBtn = document.getElementById('save-file-btn');
            const openFileLabel = document.getElementById('open-file-label');
            const themeBtn = document.getElementById('theme-btn');
            const themeMenu = document.getElementById('theme-menu');
            const hljsTheme = document.getElementById('hljs-theme');

            let isDirty = false;

            // --- Theme Handling ---
            const updateSelectedIndicator = (theme) => {
                document.querySelectorAll('.theme-menu button').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('selected');
                    }
                });
            };

            const applyTheme = (theme) => {
                const isDarkMode = theme === 'dark';
                document.documentElement.classList.toggle('dark', isDarkMode);
                document.documentElement.classList.toggle('light', !isDarkMode);
                hljsTheme.href = isDarkMode 
                    ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css' 
                    : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
                preview.classList.toggle('prose-invert', isDarkMode);
            };

            const getSystemTheme = () => window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

            const loadTheme = () => {
                const savedTheme = localStorage.getItem('theme') || 'system';
                updateSelectedIndicator(savedTheme);
                let themeToApply = savedTheme;
                if (savedTheme === 'system') {
                    themeToApply = getSystemTheme();
                }
                applyTheme(themeToApply);
            };

            themeBtn.addEventListener('click', () => {
                themeMenu.style.display = themeMenu.style.display === 'block' ? 'none' : 'block';
            });

            themeMenu.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    const selectedTheme = button.dataset.theme;
                    localStorage.setItem('theme', selectedTheme);
                    updateSelectedIndicator(selectedTheme);
                    let themeToApply = selectedTheme;
                    if (selectedTheme === 'system') {
                        themeToApply = getSystemTheme();
                    }
                    applyTheme(themeToApply);
                    themeMenu.style.display = 'none';
                }
            });
            
            window.addEventListener('click', (e) => {
                if (!themeBtn.contains(e.target) && !themeMenu.contains(e.target)) {
                    themeMenu.style.display = 'none';
                }
            });

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (localStorage.getItem('theme') === 'system') {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });

            loadTheme();
            // --- End Theme Handling ---


            // Configure Showdown
            const converter = new showdown.Converter({
                ghCompatibleHeaderId: true,
                simpleLineBreaks: true,
                strikethrough: true,
                tables: true,
                tasklists: true,
                emoji: true
            });

            // Function to update the preview
            function updatePreview() {
                const markdownText = editor.value;
                const html = converter.makeHtml(markdownText);
                preview.innerHTML = html;
                preview.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            // Sync editor content to preview in real-time
            editor.addEventListener('input', function() {
                isDirty = true;
                updatePreview();
            });

            // Handle file opening
            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editor.value = e.target.result;
                        updatePreview();
                        isDirty = false;
                    };
                    reader.onerror = function() {
                        console.error("Failed to read file.");
                        alert("Error: Could not read the selected file.");
                    };
                    reader.readAsText(file);
                }
            });

            // Initial placeholder content
            editor.value = '# Welcome to Markdown Reader!\n\n' +
                'This is a minimalist, real-time Markdown viewer. Start typing in the editor on the left, and see the formatted output on the right instantly.\n\n' +
                '---\n\n' +
                '## Key Features\n\n' +
                '*   **Live Preview:** Your document is rendered as you type.\n' +
                '*   **Syntax Highlighting:** Code blocks are automatically highlighted.\n' + 
                '*   **GitHub Flavored Markdown:** Supports tables, strikethrough, and more.\n\n' +
                '### Examples\n\n' +
                '> Blockquotes are perfect for highlighting important information.\n\n' +
                '**Tables are easy to create:**\n\n' +
                '| Feature         | Status      |\n' + 
                '| --------------- | ----------- |\n' +
                '| Real-time Sync  | ✅ Complete |\n' +
                '| File Opening    | ✅ Complete |\n' +
                '| Code Highlighting| ✅ Complete |\n\n' +
                '**Code blocks with syntax highlighting:**\n\n' +
                '```python\n' +
                '# Simple Python function\n' +
                'def greet(name):\n' +
                '    return f"Hello, {name}!"\n\n' +
                'print(greet("World"))\n' +
                '```\n\n' +
                'Start by clearing this text or click \'Open File\' to load your own Markdown file.';
            updatePreview();

            // Handle New File button click
            newFileBtn.addEventListener('click', function() {
                if (isDirty && !confirm('You have unsaved changes. Are you sure you want to start a new file?')) {
                    return;
                }
                editor.value = '';
                updatePreview();
                isDirty = false;
            });

            // Handle Save File button click
            saveFileBtn.addEventListener('click', function() {
                const markdownContent = editor.value;
                const blob = new Blob([markdownContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'untitled.md';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                isDirty = false;
            });

            openFileLabel.addEventListener('click', function(event) {
                if (isDirty && !confirm('You have unsaved changes. Are you sure you want to open a new file?')) {
                    event.preventDefault();
                }
            });

            window.addEventListener('beforeunload', function (e) {
                if (isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>

</body>
</html>